%%DEFINE_HEADER%%
<div id="overlay"></div>
<div id="popupDialog"></div>

IF("%%DEFINE_manage_signatures%%" == ""){
<style>
    #master_signature_box {
        display: none;
    }
</style>
{:IF}
 IF("%%DEFINE_integration_settings%%" == ""){
    <style>
        #deploy_button {
            display: none;
        }

        #import_integration {
            display: none;
        }

        #import_integration_google {
            display: none;
        }
    </style>
    {:IF}
    IF("%%DEFINE_manage_signatures%%" == ""){
    <style>
        #create_signature_btn {
            display: none;
        }

        #import_button {
            display: none;
        }
    </style>
    {:IF}

<div class="flex grow flex-col in-data-kt-[sticky-header=on]:pt-(--header-height-default) overflow-auto">
    %%DEFINE_SIDEBAR%%
    %%DEFINE_Message%%
    <input type="hidden" id="current_department" value="%%DEFINE_selected_department%%">
    <main class="grow" id="content" role="content">
        <div class="kt-container-fluid pb-4" id="master_signature_box">

            <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-2 w-full %%DEFINE_master_inner_extra_class%%">
                <div class="flex flex-col gap-2">
                    %%DEFINE_signature_process%%
                    <div class="kt-card flex-1 master_signature">
                        <div class="kt-card-header">
                            <div class="kt-card-heading">
                                <div class="kt-card-title">Master Signature</div>
                            </div>
                            <div class="kt-card-toolbar">
                                IF("%%DEFINE_plan_signaturelimit%%" != "1"){
                                <a class="kt-btn kt-btn-sm kt-btn-primary" id="createSignatureButton" href="javascript:void(0);" onclick="createMasterSignatureButton('%%DEFINE_newsignatureenterprise%%?siganature_type=master&department_id=%%DEFINE_current_department_id%%')">
                                    <i class="hgi hgi-stroke hgi-plus-sign-circle"></i>
									Create Master Signature
                                </a>
                                {:IF}
                                IF("%%DEFINE_plan_signaturelimit%%" == "1"){
                                <a class="kt-btn kt-btn-sm kt-btn-primary"
                                    href="%%DEFINE_newsignatureenterprise%%?siganature_type=master&department_id=%%DEFINE_current_department_id%%">
                                    <i class="hgi hgi-stroke hgi-plus-sign-circle"></i>
									Create Master Signature
                                </a>
                                {:IF}
                            </div>
                        </div>
                        <div class="kt-card-content relative flex items-center justify-center text-center">
                            <div class="h-full w-full overflow-auto flex items-center py-3">
                            %%DEFINE_master_signature%%
                            </div>
                        </div>
                    </div>
                </div>
                <div class="kt-card h-full">
                    <div class="kt-card-header flex-col justify-start items-start gap-3">
                        <div class="kt-card-heading">
                            <div class="kt-card-title">Analytics Snapshot</div>
                        </div>
                        <div
							class="kt-card-toolbar overflow-auto w-full *:bg-white flex *:gap-2 *:border *:border-primary *:rounded-full *:flex *:items-center *:py-2 *:pl-2 *:pr-4 *:flex-none">
                            <div>
                                <img src="%%DEFINE_IMAGE_LINK%%/images/total-icon-new.svg">
                                <div class="snapshot-data flex flex-col">
                                    <p>Total Clicks</p>
                                    <p id="total_clicks">0</p>
                                </div>
                            </div>
                            <div>
                                <img src="%%DEFINE_IMAGE_LINK%%/images/analytics-snapshot-view-icon.svg">
                                <div class="snapshot-data flex flex-col">
                                    <p>Total Impression</p>
                                    <p id="total_impressions">0</p>
                                </div>
                            </div>
                            <div>
                                <img src="%%DEFINE_IMAGE_LINK%%/images/unique-clicks-icon.svg">
                                <div class="snapshot-data flex flex-col">
                                    <p>Unique Clicks</p>
                                    <p id="total_unique_clicks">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="kt-card-content">
                        <div class="flex justify-between">
                            <div id="typeCTRSection" class="ctr-metric">
                                <div>
                                    <span class="rate" id="clickThroughRate">0 <span>%</span></span>
                                    <span class="change kt-badge" id="clickThroughChange"><span>â–²</span>+0%</span>
                                </div>
                                <span class="text-xs text-gray-500">Click-Through Rate</span>
                            </div>
                            <div class="status-selector" data-kt-dropdown="true" data-kt-dropdown-trigger="click" data-kt-dropdown-placement="bottom-end" data-kt-toggle-replace="true">
                                <button class="kt-btn bg-white border border-gray-400 text-gray-600 !rounded-full"
                                    data-kt-dropdown-toggle="true">
                                    <span>This Month</span>
                                    <i class="kt-dropdown-open:hidden">
                                        <i class="fas fa-caret-down"></i>
                                    </i>
                                    <i class="hidden kt-dropdown-open:inline">
                                        <i class="fas fa-caret-up"></i>
                                    </i>
                                </button>
                                <div class="kt-dropdown-menu w-36" data-kt-dropdown-menu="true">
                                    <ul class="status-selector-menu" data-kt-dropdown-dismiss="true">
                                        <li class="chart-range-option kt-dropdown-menu-link" data-range="today">Today</li>
                                        <li class="chart-range-option kt-dropdown-menu-link" data-range="yesterday">Yesterday</li>
                                        <li class="chart-range-option kt-dropdown-menu-link" data-range="this-week">This Week</li>
                                        <li class="chart-range-option kt-dropdown-menu-link" data-range="last-week">Last Week</li>
                                        <li class="chart-range-option kt-dropdown-menu-link" data-range="this-month">This Month</li>
                                        <li class="chart-range-option kt-dropdown-menu-link" data-range="last-month">Last Month</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="h-[300px]">
                            <canvas id="dashboardAnalyticsChart" class="h-64"></canvas>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-2 xl:col-span-1 kt-card">
                    <div class="kt-card-header">
                        <div class="kt-card-heading">
                            <div class="kt-card-title">Division List</div>
                        </div>
                        <div class="kt-card-toolbar">
                        IF("%%DEFINE_ISSUBUSER%%" == ""){
                            <a href="javascript:void(0)" class="kt-btn kt-btn-icon rounded-full kt-btn-outline kt-btn-primary" data-kt-modal-toggle="#departmentModel">
                                <i class="hgi hgi-stroke hgi-add-01"></i>
                            </a>
                        {:IF}
                        </div>
                    </div>
                    <table class="kt-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Total Member</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody class="signature_box" id="sortable-list">
                            %%DEFINE_department_list%%
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="kt-card mt-2">
                <div id="snackbar"></div>
                <div id="snackbar-error"></div>
                <div id="snackbar-info"></div>
                <div class="kt-card-header flex-col justify-start items-start">
                    <div class="kt-card-toolbar w-full flex flex-wrap justify-between items-center">
                        <div class="flex items-center gap-2 flex-wrap sm:flex-nowrap">
                            <div class="kt-input">
                                <i class="hgi hgi-stroke hgi-search-01"></i>
                                <input type="text" class="kt-input" id="search_input" placeholder="Type to Search...">
                            </div>
                            <div class="text-nowrap text-xs text-gray-600">
                                %%DEFINE_total_sigcreated%%/%%DEFINE_plan_signature%% Users
                            </div>
                            <a class="kt-btn kt-btn-primary" href="usermanagement/">
                                <i class="hgi hgi-stroke hgi-plus-sign-circle"></i> Invite New User
                            </a>
                            <div class="flex items-center text-nowrap gap-2 delete-signature group" style="display:none;" id="extratop">
                                <input type="checkbox" value="" id="select_all" class="kt-checkbox select_all" />
                                <label class="kt-label" for="select_all">Select All</label>
                                <a class="kt-btn kt-btn-destructive group-[.disabled]:bg-gray-400 group-[.disabled]:pointer-events-none" href="javascript:void(0);" data-action="bulkdelete" id="bulk_deletesignature">Delete</a>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-1">
                            <div class="flex-none" data-kt-dropdown="true" data-kt-toggle-replace='true' data-kt-dropdown-trigger="click" data-kt-dropdown-placement="bottom-end">
                                <button class="kt-btn kt-btn-primary kt-btn-outline" data-kt-dropdown-toggle="true">
                                    <span>Status</span>
                                    <i class="kt-dropdown-open:hidden">
									<i class="fas fa-caret-down"></i>
									</i>
									<i class="hidden kt-dropdown-open:inline">
									<i class="fas fa-caret-up"></i>
                                    </i>
                                </button>
                                <div class="kt-dropdown-menu w-24" data-kt-dropdown-menu="true">
                                    <ul class="kt-dropdown-menu-sub" id="signature-status-selector-menu" data-kt-dropdown-dismiss="true">
                                        <li class="kt-dropdown-menu-link" id="all">All</li>
                                        <li class="kt-dropdown-menu-link" id="installed">Installed</li>
                                        <li class="kt-dropdown-menu-link" id="pending">Pending</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="flex-none" data-kt-dropdown="true" data-kt-dropdown-trigger="click"
                                data-kt-dropdown-placement="bottom-end">
                                <button id="deploy_button" class="kt-btn kt-btn-primary kt-btn-outline" data-kt-dropdown-toggle="true">
                                    <span>Deploy</span>
                                    <i class="hgi hgi-stroke hgi-rocket-01"></i>
                                </button>
                                <div class="kt-dropdown-menu w-40" data-kt-dropdown-menu="true">
                                    <ul class="kt-dropdown-menu-sub">
                                        <li><a class="kt-dropdown-menu-link" id="deployOutlookButton" href="%%DEFINE_deployoutlook%%?department_id=%%DEFINE_current_department_id%%">Deploy to Outlook</a></li>
                                        <li><a class="kt-dropdown-menu-link" id="deployGmailButton" href="%%DEFINE_googledeploylink%%">Deploy to Gmail</a></li>
                                    </ul>
                                </div>
                            </div>

                            <div class="flex-none" data-kt-dropdown="true" data-kt-dropdown-trigger="click"
                            data-kt-dropdown-placement="bottom-end">
                                <button id="import_button" class="kt-btn kt-btn-primary kt-btn-outline"
                                    data-kt-dropdown-toggle="true">
                                    Import <i class="hgi hgi-stroke hgi-file-import"></i>
                                </button>
                                <div class="kt-dropdown-menu w-52" data-kt-dropdown-menu="true">
                                    <ul class="kt-dropdown-menu-sub" data-kt-dropdown-dismiss="true">
                                        <li><a class="kt-dropdown-menu-link" href="%%DEFINE_bulkupload%%">CSV</a></li>
                                        <li><a id="import_integration" class="kt-dropdown-menu-link"
                                            href="%%DEFINE_azuread%%?department_id=%%DEFINE_current_department_id%%">Microsoft
                                            365
                                            Active Directory</a></li>
                                        <li><a id="import_integration_google" class="kt-dropdown-menu-link"
                                            href="%%DEFINE_gsuite%%?department_id=%%DEFINE_current_department_id%%">Google
                                            Workspace</a></li>
                                    </ul>
                                </div>
                            </div>

                            IF("%%DEFINE_plan_signaturelimit%%" == "1"){
                            <a id="create_signature_btn" class="kt-btn kt-btn-primary %%DEFINE_FTDN%%" href="%%DEFINE_newsignatureenterprise%%?department_id=%%DEFINE_current_department_id%%">
                                <i class="hgi hgi-stroke hgi-add-01"></i> Create Signature
                            </a>
                            <a id="create_signature_btn" class="kt-btn kt-btn-primary %%DEFINE_FTD%%" href="%%DEFINE_billing%%?action=freetrial&department_id=%%DEFINE_current_department_id%%">
                                <i class="hgi hgi-stroke hgi-add-01"></i> Create Signature
                            </a>
                            {:IF}
                        </div>
                    </div>
                </div>
                <div class="kt-card-content grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="search_result">
                    %%DEFINE_signature_list%%
                    %%DEFINE_signature_create_upgrade%%
                </div>
            </div>
        </div>
    </main>
</div>


<div class="kt-modal kt-modal-center" data-kt-modal="true" id="reviewModal">
    <div class="kt-modal-content max-w-[400px]">
        <div class="kt-modal-header">
            <h3 class="kt-modal-title">Modal Title</h3>
            <button type="button" class="kt-modal-close" aria-label="Close modal" data-kt-modal-dismiss="#reviewModal">
                <i class="hgi hgi-stroke hgi-add-circle"></i>
            </button>
        </div>
        <div class="kt-modal-body">
            <div class="preview-logo"></div>
            <div class="flex justify-center mt-3 gap-2">
                <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#feedbackModal">Would
                    like to revise</button>
                <a href="javascript:void(0);" class="btn btn-primary ajaxaction" id="looksgood" data-id="0"
                    data-action="status">Look Goods!</a>
            </div>
        </div>
    </div>
</div>

<div class="kt-modal kt-modal-center" data-kt-modal="true" id="changeLogoModel">
    <div class="kt-modal-content max-w-[400px]">
        <div class="kt-modal-header">
            <p class="kt-modal-title">Upload Brand Logo</p>
            <button type="button" class="kt-modal-close" aria-label="Close modal"
                data-kt-modal-dismiss="#changeLogoModel">
                <i class="hgi hgi-stroke hgi-add-circle"></i>
            </button>
        </div>
        <div class="kt-modal-body">
            <input class="signature_logo" type="file" name="signature_logo" id="signature_logo" style="display:none;">
            <div id="img_preview_logo"></div>
            <div class="upload-area-logo" id="uploadfilelogo">
                <input type="hidden" value="%%DEFINE_signature_image_name%%" name="signature_image">
                <div class="drag_your_image border border-dashed border-gray-400 flex items-center justify-center flex-col p-10 rounded-xl">
                    <img class="max-w-36 max-h-36 object-cover" src="%%DEFINE_signature_change_image%%" alt="">
                    <p class="text-[#063E76] font-semibold mt-2">Drag your image here, or <a class="text-primary" href="javascript:void(0);">browse</a></p>
                    <p class="text-xs text-gray-400">Supports: PNG, SVG, JPG, JPEG</p>
                </div>
            </div>
            <div id="img_errormsg_logo"></div>
            <div class="kt-alert kt-alert-outline kt-alert-primary my-3">
                <p><b>Note:</b> Please upload a logo with dimensions <b>500Ã—500 and above pixels</b> for
                better animation quality.</p>
            </div>
                <label class="kt-form-label">Please add feedback</label>
                <div class="flex gap-2">
                    <input type="hidden" name="logo_id" value="%%DEFINE_signature_logo_id%%">
                    <input type="text" class="kt-input" name="change_reason" placeholder="Reason for change logo">
                    <a href="javascript:void(0);" class="kt-btn kt-btn-primary" id="logo_change_done_btn" onclick="logoChanged();">Submit</a>
                </div>
                <div id="feedback_errormsg_logo" class="text-danger"></div>
        </div>
    </div>
</div>

<div class="kt-modal kt-modal-center" data-kt-modal="true" id="feedbackModal">
    <div class="kt-modal-content max-w-[400px]">
        <div class="kt-modal-header">
            <h3 class="kt-modal-title">Feedback</h3>
            <button type="button" class="kt-modal-close" aria-label="Close modal"
                data-kt-modal-dismiss="#feedbackModal">
                <i class="hgi hgi-stroke hgi-add-circle"></i>
            </button>
        </div>
        <div class="kt-modal-body">
            <textarea name="feedback" id="feedback" rows="5" class="form-control"></textarea>
        </div>
        <div class="kt-modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-toggle="modal" id="backreview"
                data-bs-target="#reviewModal" data-img="" data-id="">Back</button>
            <button type="button" class="btn btn-primary" id="sendfeedback">Send Feedback! <img
                    src="%%DEFINE_IMAGE_LINK%%/images/arrow-right.svg" alt=""></button>
        </div>
    </div>
</div>

<div class="kt-modal kt-modal-center" data-kt-modal="true" id="thanksModal">
    <div class="kt-modal-content max-w-[400px]">
        <div class="kt-modal-header">
            <button type="button" class="kt-modal-close" aria-label="Close modal" data-kt-modal-dismiss="#thanksModal">
                <i class="hgi hgi-stroke hgi-add-circle"></i>
            </button>
        </div>
        <div class="kt-modal-body">
            <h3>Thank You!</h3>
            <p>We will revert within 48hrs.</p>
        </div>
    </div>
</div>

<div class="kt-modal kt-modal-center" data-kt-modal="true" id="shareModal">
    <div class="kt-modal-content max-w-[600px]">
        <div class="kt-modal-header">
            <p class="kt-modal-title">Share Signature</p>
            <button type="button" class="kt-modal-close" aria-label="Close modal" data-kt-modal-dismiss="#shareModal">
                <i class="hgi hgi-stroke hgi-cancel-circle"></i>
            </button>
        </div>
        <div class="kt-modal-body">
            <p class="text-lg mb-2 mt-4">You can share the signature by copying the installation link</p>
            <label class="kt-form-label" for="">Url</label>
            <div class="flex gap-2">
                <input type="text" class="kt-input" id="share_url" name="share_url" placeholder="Share Url" required="required" value="">
                <a href="javascript:void(0);" id="copyshareurl" class="kt-btn kt-btn-primary">
                    <i class="hgi hgi-stroke hgi-copy-01"></i> Copy
                </a>
            </div>
            <p class="text-lg mb-2 mt-4">or send by email to your team member</p>
            <label class="kt-form-label">Email id</label>
            <div class="flex gap-2">
                <input type="text" class="kt-input" id="share_email" name="share_email" placeholder="Email Address" required="required" value="">
                <a href="javascript:void(0);" class="kt-btn kt-btn-primary ajaxaction_share" id="sharesig" data-id="0" data-action="share">
                    <i class="hgi hgi-stroke hgi-sent"></i>Send
                </a>
            </div>
        </div>
    </div>
</div>

<div class="kt-modal kt-modal-center" data-kt-modal="true" id="upgradeFromFreeTrialPopup">
	<div class="kt-modal-content max-w-[400px]">
		<div class="kt-modal-header">
			<p class="kt-modal-title invisible">Upgrade Your Plan</p>
			<button type="button" class="kt-modal-close" aria-label="Close modal"
				data-kt-modal-dismiss="#upgradeFromFreeTrialPopup">
				<i class="hgi hgi-stroke hgi-cancel-circle"></i>
			</button>
		</div>
		<div class="kt-modal-body text-center">
			<p class="text-lg font-semibold">Your 7-day free trial has ended. You will now be charged according to your selected plan, and your logo animation will begin.</p>
			<div class="text-center mt-4">
				<a href="javascript:void(0);" onclick="endFreeTrialNow();" class="kt-btn kt-btn-primary">Animate Now</a>
			</div>
		</div>
	</div>
</div>


<div class="kt-modal kt-modal-center" data-kt-modal="true" id="departmentModel">
    <div class="kt-modal-content max-w-[400px]">
        <div class="kt-modal-header">
            <p class="kt-modal-title" id="department_title">Add Company Division</p>
            <button type="button" class="kt-modal-close" aria-label="Close modal"
                data-kt-modal-dismiss="#departmentModel">
                <i class="hgi hgi-stroke hgi-cancel-circle"></i>
            </button>
        </div>
        <div class="kt-modal-body">
            <form action="" method="post" id="departmentForm">
                <div class="inputbox">
                    <label class="kt-form-label">Company Division Name</label>
                    <input type="text" class="kt-input" name="department_name" id="department_name"
                        placeholder="Company Division Name" data-class="department_name">
                    <span class="input-error-message"></span>
                </div>
                <div class="inputbox department-logo-container" style="display:none;">
                    <div class="flex items-center gap-2 toggleCheckbox-title">
                        <label class="kt-label" for="toggleCheckbox">Do you want to use same logo?</label>
                        <input class="kt-checkbox" type="checkbox" id="toggleCheckbox" checked>
                    </div>

                    <div class="upload_logo_bg" id="hiddenDepartmentLogoDiv" style="display: none;">
                        <h4 class="upload-title">Upload Division Logo</h4>
                        <input class="signature_department_logo" type="file" name="signature_department_logo"
                            id="signature_department_logo" style="display:none;">
                        <div id="img_preview_logo"></div>
                        <div class="upload-area-department-logo" id="uploadfiledepartmentlogo">
                            <input type="hidden" value="%%DEFINE_signature_department_image_name%%"
                                name="signature_department_image" id="signature_department_image">
                            <div class="drag_your_image"> <img class="signature_department_logo"
                                    src="%%DEFINE_IMAGE_LINK%%/images/upload-img-icon.svg" alt="">
                                <h4>Drag your image here, or <a href="javascript:void(0);">browse</a></h4>
                                <p>Supports: PNG, SVG, JPG, JPEG</p>
                            </div>
                        </div>
                        <div id="img_errormsg_logo"></div>
                    </div>
                </div>
                <div class="mt-4 text-center">
                    <button type="submit" name="next" class="departmentSubmit kt-btn kt-btn-primary next action-button"
                        value="Next Step">Save Division</button>
                </div>
            </form>
            <input type="hidden" id="form_url" value="%%DEFINE_linkModuleDashboard%%" />
            <input type="hidden" id="form_url_with_department"
                value="%%DEFINE_linkModuleDashboard%%?department_id=%%DEFINE_current_department_id%%" />
            <input type="hidden" id="form_url_department"
                value="%%DEFINE_departmententerprise%%?department_id=%%DEFINE_current_department_id%%" />
            <input type="hidden" id="form_url_dragdrop" value="%%DEFINE_departmententerprise%%/update-positions" />
            <input type="hidden" id="redirecturl" value="%%DEFINE_linkModuleNewsignature%%/done" />
            <input type="hidden" id="redirecturld" value="%%DEFINE_linkModuleDashboard%%" />
        </div>
    </div>
</div>


<script src="%%DEFINE_ROOT_LINK%%/script/jquery-3.5.1.min.js"></script>
<script src="%%DEFINE_ROOT_LINK%%/dist/assets/vendors/sweetalert2/sweetalert2.bundle.js"></script>

<script>
    

    const list = document.getElementById('sortable-list');
    let draggingItem = null;

    // Set up drag events for <li> elements
    list.addEventListener('dragstart', (e) => {
        if (e.target.classList.contains('handle')) {
            draggingItem = e.target.closest('tr');
            draggingItem.classList.add('dragging');
        }
    });

    list.addEventListener('dragend', (e) => {
        if (draggingItem) {
            draggingItem.classList.remove('dragging');
            draggingItem = null;
        }
    });

    list.addEventListener('dragover', (e) => {
        e.preventDefault(); // Prevent default behavior (e.g., open as link)
        const afterElement = getDragAfterElement(list, e.clientY);
        const draggingElement = draggingItem;

        if (afterElement == null) {
            list.appendChild(draggingElement);
        } else {
            list.insertBefore(draggingElement, afterElement);
        }
    });

    function getDragAfterElement(list, y) {
        const listItems = [...list.querySelectorAll('tr:not(.dragging)')];
        return listItems.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return {
                    offset: offset,
                    element: child
                };
            } else {
                return closest;
            }
        }, {
            offset: Number.NEGATIVE_INFINITY
        }).element;
    }

    // Function to send AJAX request with new positions
    function sendPositionUpdate() {
        const items = [...list.querySelectorAll('tr')];
        const positions = items.map((item, index) => ({
            id: $(item).data('department-id'), // Use the text content or an ID if available
            position: index + 1
        }));

        // Send the updated positions via AJAX
        const xhr = new XMLHttpRequest();
        xhr.open('POST', $("#form_url_dragdrop").val(), true); // URL for your server endpoint
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                console.log('Positions updated successfully');
            }
        };
        xhr.send(JSON.stringify({
            positions: positions
        }));
    }

    // Send position update when the drag operation is completed
    list.addEventListener('drop', function (e) {
        sendPositionUpdate();
    });
</script>

<script language="javascript">
    $(document).ready(function () {
        $(".departmentSubmit").click(function (event) {
            var redirecturl = $('#redirecturl').val();
            var redirecturld = $('#redirecturld').val();
            var validate = 1;

            if ($('#department_name').val().trim() === "") {
                $('#department_name').css('border-color', '#842029');
                validate = 0;
                $('#department_name').siblings('.input-error-message').text('Please enter valid division name');
                $('#department_name').siblings('.input-error-message').css('color', '#842029');
            } else {
                $('#department_name').css('border-color', '');
                validate = 1;
                $('#department_name').siblings('.input-error-message').text('');
                $('#department_name').siblings('.input-error-message').css('color', '');
            }
            if (validate != 1) {
                event.stopPropagation();
                return false;
            }
            var form = $('#departmentForm');
            data = form.serialize();
            formUrl = $('#form_url_department').val();

            $.ajax({
                type: 'POST',
                url: formUrl,
                data: form.serialize()
            }).done(function (data) {
                var json = JSON.parse(data);
                if (json.error != 1) {
                    $('#snackbar').html('<div class="alert alert-success"><i class="fa-solid fa-circle-check text-green-500"></i><strong>Success! </strong>Division saved! </div>');
                    $('.btn-close').click();
                    $('#snackbar').show();
                    setTimeout(function () {
                        $('#snackbar').hide();
                        window.location = redirecturld;
                    }, 2000);
                    setTimeout(function () {
                        x.className = x.className.replace("show", "");
                        window.location = redirecturld;
                    }, 2000);
                } else {
                    $('#snackbar-error').html('<div class="alert alert-danger"><i class="fa-solid fa-triangle-exclamation text-danger"></i><strong>Failure! </strong>' + json.msg + ' </div>');
                    $('#snackbar-error').show();
                    setTimeout(function () {
                        $('#snackbar-error').hide();
                    }, 2000);
                    $('.btn-close').click();
                    return false;
                }
                // Optionally alert the user of success here...
            }).fail(function (data) {
                return false;
                // Optionally alert the user of an error here...
            });
            return false;
        });
        $(".clickableAnchor").click(function (e) {
            // e.stopPropagation();
            $('#department_name').val($(this).data('department_name'));
            if ($('#edit_department').length && $('#department_id').length) {
                $('#edit_department').val('1');
                $('#department_id').val($(this).data('department_id'));
            } else {
                $('#departmentForm').append('<input type="hidden" name="edit_department" id="edit_department" value="1" />');
                $('#departmentForm').append('<input type="hidden" name="department_id" id="department_id" value="' + $(this).data('department_id') + '" />');
            }
            $('#department_title').html('Edit Company Division');
            // $(".department-logo-container").hide();
        });
        $(".adddepartment").click(function (e) {
            e.stopPropagation();
            $('#department_name').val('');
            $('#department_title').html('Add Company Division');
            $('#edit_department').remove();
            $('#department_id').remove();
            // $(".department-logo-container").show();
        });
        $("#toggleCheckbox").click(function (e) {
            if ($(this).is(':checked')) {
                $("#hiddenDepartmentLogoDiv").css('display', 'none');
            } else {
                $("#hiddenDepartmentLogoDiv").css('display', 'block');
            }
        });
    });
</script>
<!-- <script src="%%DEFINE_JS_LINK%%/htmltoimage/html2canvas.js"></script> 
<script src="%%DEFINE_JS_LINK%%/htmltoimage/htmltoimage.js"></script>  -->
<script>
    function myFunction(objid) {
        $('.menu_open:not(#myDIV' + objid + ')').hide();
        divobj = 'myDIV' + objid;
        var x = document.getElementById(divobj);

        if (x.style.display === "none") {
            x.style.display = "block";
        } else {
            x.style.display = "none";
        }
    }
    $(document).on('click', function (event) {
        if (!$(event.target).closest('.menu_open').length && !$(event.target).is('.openPopupClass')) {
            $('.menu_open').hide();
        }
    });


    const feedbackModalEl = document.querySelector('#feedbackModal');
    const feedbackModal = KTModal.getInstance(feedbackModalEl);

    const thanksModalEl = document.querySelector('#thanksModal');
    const thanksModal = KTModal.getInstance(thanksModalEl);

    $(document).ready(function () {
        // delete and copy signature action
        var getUrlParameter = function getUrlParameter(sParam) {
            var sPageURL = window.location.search.substring(1),
                sURLVariables = sPageURL.split('&'),
                sParameterName,
                i;

            for (i = 0; i < sURLVariables.length; i++) {
                sParameterName = sURLVariables[i].split('=');

                if (sParameterName[0] === sParam) {
                    return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
                }
            }
            return false;
        };
        $('.delete_department').on("click", function () {
            if (!$(this).hasClass('clickedFromDeleteConfirmationPopup')) {
                openDeleteModal($(this), "Are you sure you want to delete this division?", "This division will be permanently removed.");
                return false;
            }
            // var text = "Do you really want to delete division.";
            // if (confirm(text) == true) {
            //     text = "You pressed OK!";
            // } else {
            //     text = "You canceled!";
            //     return false;
            // }

        });


        $('.ajaxaction').on("click", function () {
            var id = $(this).attr('data-id');
            var action = $(this).attr('data-action');
            var url = $('#form_url').val();
            var department_id = getUrlParameter('department_id');

            if (action == 'delete') {
                // var confirmation = confirm("are you sure you want to delete the signature?");
                if (!$(this).hasClass('clickedFromDeleteConfirmationPopup')) {
                    openDeleteModal($(this), "Are you sure you want to delete this signature?", "This signature will be permanently removed.");
                    var confirmation = false;
                } else {
                    var confirmation = true;
                }
            } else {
                confirmation = true;
            }
            if (confirmation) {
                $.ajax({
                    type: 'POST',
                    url: $('#form_url').val(),
                    data: 'action=' + action + '&id=' + id + '&department_id=' + department_id,
                    dataType: "json",
                }).done(function (data) {
                    if (data.error == '0') {
                        location.reload();
                    } else {

                        $('#snackbar-error').html('<div class="alert alert-danger"><img src="%%DEFINE_IMAGE_LINK%%/images/error-message-icon.svg" alt=""><strong>Failure! </strong>' + data.msg + ' </div>');
                        $('#snackbar-error').show();
                        setTimeout(function () {
                            $('#snackbar-error').hide();
                        }, 2000);
                        return false;
                    }
                    this.bind('click', handler);
                    // Optionally alert the user of success here...
                }).fail(function (data) {
                    return false;
                    // Optionally alert the user of an error here...
                });
                return false;
            }
        });


        // bulk delte
        $('#bulk_deletesignature').on("click", function () {

            if (!$(this).hasClass('clickedFromDeleteConfirmationPopup')) {
                openDeleteModal($(this), "Are you sure you want to delete these signatures?", "These signatures will be permanently removed.");
                return false;
            }

            $('#bulk_deletesignature').html('<span class="kt-btn kt-btn-destructive flex items-center"><span>Delete..</span><i class="fas fa-circle-notch fa-spin"></i></span>');
            var ids = [];
            $('.del_chekbox:checked').each(function (i, e) {
                ids.push($(this).val());
            });
            var id = ids;
            var action = $(this).attr('data-action');
            var url = $('#form_url').val();
            confirmation = true;
            if (confirmation) {
                $.ajax({
                    type: 'POST',
                    url: $('#form_url').val(),
                    data: 'action=' + action + '&id=' + id,
                    dataType: "json",
                }).done(function (data) {
                    if (data.error == '0') {
                        urlReidrect = $('#form_url_with_department').val();
                        window.location = urlReidrect;
                    } else {
                        alert(data.msg);
                        return false;
                    }
                    this.bind('click', handler);
                    // Optionally alert the user of success here...
                }).fail(function (data) {
                    return false;
                    // Optionally alert the user of an error here...
                });
                return false;
            }
        });

        // share signature mail

        // delete and copy signature action
        $('.ajaxaction_share').on("click", function () {
            var id = $(this).attr('data-id');
            var action = $(this).attr('data-action');
            var url = $('#form_url').val();
            var mailto = $('#share_email');
            var share_url = $('#share_url').val();
            console.log(share_url)
            if (mailto.val() == '') {
                mailto.focus();
            } else {
                $.ajax({
                    type: 'POST',
                    url: $('#form_url').val(),
                    data: {
                        action: action,
                        id: id,
                        share_email: mailto.val(),
                        share_url: share_url
                    },
                    dataType: "json",
                }).done(function (data) {
                    if (data.error == '0') {

                        $('#snackbar').html('<div class="alert alert-success"><img src="%%DEFINE_IMAGE_LINK%%/images/success-message-icon.svg" alt=""><strong>Success! </strong>Signature mail has been sent! </div>');
                        $('#snackbar').show();
                        setTimeout(function () {
                            $('#snackbar').hide();
                        }, 2000);
                        // shareModal.hide();
                        $(".kt-modal-close").click();
                    } else {
                        alert('somthing wrong try again');
                        return false;
                    }
                    // this.bind('click',handler);
                    // Optionally alert the user of success here...
                }).fail(function (data) {
                    return false;
                    // Optionally alert the user of an error here...
                });
                return false;
            }
        });

        // send feedback signature

        $('#sendfeedback').on("click", function () {
            var signatureid = $('#backreview').attr('data-id');
            var feedback = $('#feedback');
            if ($.trim(feedback.val()) == "") {
                feedback.css('border-color', 'red');
                return false;
            }
            var url = $('#form_url').val();
            $.ajax({
                type: 'POST',
                url: $('#form_url').val(),
                data: 'feedback=' + feedback.val() + '&signature_id=' + signatureid,
                dataType: "json",
                async: true,
            }).done(function (data) {
                if (data['error'] == '0') {
                    feedbackModal.hide();
                    thanksModal.show();
                    window.location = url;
                    // return false;
                } else {
                    alert(data['error']);
                    return false;
                }
                this.bind('click', handler);
                // Optionally alert the user of success here...
            }).fail(function (data) {
                return false;
                // Optionally alert the user of an error here...
            });
            return false;
        });

        // search box
        $("#search_input").keyup(function () {
            var filter = $(this).val(),
                count = 0;
            $('#search_result div.search-container').each(function () {
                if ($(this).text().search(new RegExp(filter, "i")) < 0) {
                    $(this).hide();
                } else {
                    $(this).show();
                    count++;
                }
                $('.menu_open').hide();
            });
        });

    });

    const reviewModalEl = document.querySelector('#reviewModal');
    const reviewModal = KTModal.getInstance(reviewModalEl);

    reviewModal.on('show', () => {
        var button = event.relatedTarget
        var reviewlogo = button.getAttribute('data-img');
        var signatureId = button.getAttribute('data-id');
        document.getElementById("looksgood").setAttribute('data-id', signatureId);
        document.getElementById("backreview").setAttribute('data-id', signatureId);
        document.getElementById("backreview").setAttribute('data-img', reviewlogo);
        var imgBody = reviewModalEl.querySelector('.preview-logo');
        imgBody.innerHTML = '<img src="' + reviewlogo + '" ,alt="" />';
    });

    const changeLogoModelEl = document.querySelector('#changeLogoModel');
    const changeLogoModel = KTModal.getInstance(changeLogoModelEl);

    changeLogoModel.on('show', () => {
        var button = event.relatedTarget
        var reviewlogo = button.getAttribute('data-img');
        var signatureId = button.getAttribute('data-id');
        document.getElementById("looksgood").setAttribute('data-id', signatureId);
        document.getElementById("backreview").setAttribute('data-id', signatureId);
        document.getElementById("backreview").setAttribute('data-img', reviewlogo);
    });

    const departmentModelEl = document.querySelector('#departmentModel');
    const departmentModel = KTModal.getInstance(departmentModelEl);

    // const shareModalEl = document.querySelector('#shareModal');
    // const shareModal = KTModal.getInstance(shareModalEl);

    // shareModal.on('show', () => {
    //     var button = event.relatedTarget
    //     var signatureId = button.getAttribute('data-id');
    //     var shareUrl = button.getAttribute('data-url');
    //     var shareEmail = button.getAttribute('data-email');
    //     document.getElementById("share_url").value = shareUrl;
    //     document.getElementById("share_email").value = shareEmail;
    //     document.getElementById("sharesig").setAttribute('data-id', signatureId);
    // });

    $(document).ready(function () { 

        $('[data-kt-modal-toggle="#departmentModel"]').on('click', function() {
            departmentModel.show();
        });


        $('[title="Share"]').on('click', function (event) {
            console.log('hello')
            var button = $(this);
            var signatureId = button.attr('data-id');
            var shareUrl = button.attr('data-url');
            var shareEmail = button.attr('data-email');
            $("#share_url").val(shareUrl);
            $("#share_email").val(shareEmail);
            $("#sharesig").attr('data-id', signatureId);
        });

        $('#copyshareurl').on('click', function (event) { // copy signature
            text = $('#share_url').val();
            var textField = $('#share_url');
            textField.focus(); //SET FOCUS on the TEXTFIELD
            textField.select();
            document.execCommand('copy');
            console.log('should have copied ' + text);
            $('#shareModal').focus();

            $('#snackbar').html('<div class="alert alert-success"><img src="%%DEFINE_IMAGE_LINK%%/images/success-message-icon.svg" alt=""><strong>Success! </strong>Link has been copied to clipboard! </div>');
            $('#snackbar').show();
            setTimeout(function () {
                $('#snackbar').hide();
            }, 2000);
            shareModal.hide();
        });
    });
</script>

<script language="javascript">
    $(document).ready(function () {
        $('#select_all').on('click', function () {
            if (this.checked) {
                $('.del_chekbox').each(function () {
                    this.checked = true;
                    $('.delete-signature').removeClass('disabled');
                });
            } else {
                $('.del_chekbox').each(function () {
                    this.checked = false;
                    $('.delete-signature').addClass('disabled');
                });
            }
        });

        $('.del_chekbox').on('click', function () {
            if ($('.del_chekbox:checked').length == $('.del_chekbox').length) {
                $('#select_all').prop('checked', true);
                $('.delete-signature').removeClass('disabled');
            } else {
                $('#select_all').prop('checked', false);
                $('.delete-signature').addClass('disabled');
            }

            if ($('.del_chekbox:checked').length < 1) {
                $('#extratop').css('display', 'none');
                $('.delete-signature').addClass('disabled');
            } else {
                $('#extratop').css('display', '');
                $('.delete-signature').removeClass('disabled');
            }
        });
    });
</script>

<script language="javascript">
    $(document).ready(function () {
        $('.department_container').first().click();
        $('.department_container').on('click', function () {
            $('.department_container').removeClass('department_selected bg-gray-100');
            $(this).addClass('department_selected bg-gray-100');
            current_department = $(this).data('department-id');
            window.history.replaceState(null, null, "?department_id=" + current_department);
            location.reload();
        });
        var $container = $(".signature_box");
        var $scrollTo = $('.department_selected');
        $container.animate({
            scrollTop: $scrollTo.offset().top - $container.offset().top + $container.scrollTop(),
            scrollLeft: 0
        }, 300);
    });
    var urlParams = new URLSearchParams(window.location.search); //get all parameters
    var department_id = urlParams.get('department_id'); //extract the department_id parameter - this will return NULL if department_id isn't a parameter
    if (department_id) { //check if department_id parameter is set to anything

    } else {
        current_department = $("#current_department").val();
        window.history.replaceState(null, null, "?department_id=" + current_department);
        location.reload();
    }
</script>
IF("%%DEFINE_IMPORT_SIGNATURE_PENDING_COUNT%%" > "0"){
<script language="javascript">
    $(document).ready(function () {
        processPendingImportedSignature();
    });
</script>
{:IF}
<script src="%%DEFINE_JS_LINK%%/uploadlogo.js?v=%%DEFINE_CSS_VERSION%%" type="text/javascript"></script>

<script>
    $(document).ready(function () {
        $('[data-toggle="tooltip"]').tooltip();
    });
</script>

<script>
    $(document).ready(function () {
        const urlParams = new URLSearchParams(window.location.search);
        const paramValue = urlParams.get('department_id');
        $('.department_container').removeClass('department_selected bg-gray-100');
        $("[data-department-id=" + paramValue + "]").addClass('department_selected bg-gray-100');
    });
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        setTimeout(function () {
            var errorMsg = document.getElementById("error-msg");
            if (errorMsg) {
                errorMsg.style.display = "none";
            }
        }, 5000);
    });
</script>

<script src="%%DEFINE_ROOT_LINK%%/script/chart.js"></script>
<script src="%%DEFINE_ROOT_LINK%%/script/mapchart/chart.umd.js"></script>
<script src="%%DEFINE_ROOT_LINK%%/script/mapchart/index.umd.min.js"></script>
<script>
    let chart;

    function getMaxValue(data) {
        const allValues = [...data.clicks, ...data.impressions, ...data.unique_clicks];
        return allValues.length ? Math.max(...allValues) : 0;
    }
    function getControlPoints(points, tension) {
        const cp = [];
        const n = points.length;

        for (let i = 0; i < n; i++) {
            const p0 = points[i === 0 ? i : i - 1];
            const p1 = points[i];
            const p2 = points[i === n - 1 ? i : i + 1];

            const d01 = Math.hypot(p1.x - p0.x, p1.y - p0.y);
            const d12 = Math.hypot(p2.x - p1.x, p2.y - p1.y);

            let cp1x = p1.x, cp1y = p1.y, cp2x = p1.x, cp2y = p1.y;

            if (d01 + d12 !== 0) {
                const fa = tension * d01 / (d01 + d12);
                const fb = tension * d12 / (d01 + d12);

                cp1x = p1.x - fa * (p2.x - p0.x);
                cp1y = p1.y - fa * (p2.y - p0.y);

                cp2x = p1.x + fb * (p2.x - p0.x);
                cp2y = p1.y + fb * (p2.y - p0.y);
            }

            cp.push({ cp1: { x: cp1x, y: cp1y }, cp2: { x: cp2x, y: cp2y } });
        }

        return cp;
    }

    const verticalGradientHighlightPlugin = {
        id: 'verticalGradientHighlightPlugin',
        beforeDatasetsDraw(chart) {
            const tooltip = chart.tooltip;

            // Ensure tooltip is active (hovering)
            if (!tooltip || !tooltip._active || !tooltip._active.length) return;

            const ctx = chart.ctx;
            const activePoint = tooltip._active[0];

            // Get X position of the active point
            const x = activePoint.element.x;

            // Get chart area boundaries
            const topY = chart.chartArea.top;
            const bottomY = chart.chartArea.bottom;

            // Create linear gradient
            const gradient = ctx.createLinearGradient(x - 50, 0, x + 50, 0);
            gradient.addColorStop(0, 'rgba(0, 204, 255, 0.1)');
            gradient.addColorStop(1, 'rgba(0, 71, 255, 0.1)');

            // Draw rectangle
            ctx.save();
            ctx.fillStyle = gradient;
            ctx.fillRect(x - 50, topY, 100, bottomY - topY);
            ctx.restore();
        }
    };


    const lineShadowFillPlugin = {
        id: 'lineShadowFillPlugin',
        beforeDatasetsDraw(chart) {
            const ctx = chart.ctx;
            const datasetIndex = 0; // Clicks dataset index
            const meta = chart.getDatasetMeta(datasetIndex);
            if (meta.hidden) return;

            const points = meta.data;
            if (!points.length) return;

            const bottom = chart.chartArea.bottom;

            // Extract raw points and clamp y to baseline
            const pts = points.map(p => ({
                x: p.x,
                y: Math.min(p.y, bottom) // Clamp point y to baseline
            }));

            const tension = chart.data.datasets[datasetIndex].tension ?? 0;

            // Calculate control points for bezier curve
            const controlPoints = getControlPoints(pts, tension);

            // Clamp control points y to baseline so curve won't dip below
            controlPoints.forEach(cp => {
                cp.cp1.y = Math.min(cp.cp1.y, bottom);
                cp.cp2.y = Math.min(cp.cp2.y, bottom);
            });

            ctx.save();

            // Start path at bottom-left
            ctx.beginPath();
            ctx.moveTo(pts[0].x, bottom);

            // Line up to first point
            ctx.lineTo(pts[0].x, pts[0].y);

            // Draw bezier curves through points using control points
            for (let i = 1; i < pts.length; i++) {
                const cpPrev = controlPoints[i - 1];
                const cpCurr = controlPoints[i];

                ctx.bezierCurveTo(
                    cpPrev.cp2.x, cpPrev.cp2.y,
                    cpCurr.cp1.x, cpCurr.cp1.y,
                    pts[i].x, pts[i].y
                );
            }

            // Line down to bottom at last point
            ctx.lineTo(pts[pts.length - 1].x, bottom);
            ctx.closePath();

            // Create vertical gradient for fading shadow effect
            const gradient = ctx.createLinearGradient(0, chart.chartArea.top, 0, chart.chartArea.bottom);
            gradient.addColorStop(0, 'rgba(77, 127, 255, 0.3)');
            gradient.addColorStop(1, 'rgba(77, 127, 255, 0)');

            ctx.shadowColor = 'rgba(77, 127, 255, 0.3)'; // Brighter, soft glow
            ctx.shadowBlur = 25;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;

            ctx.fillStyle = gradient;  // Use gradient fill instead of solid color
            ctx.fill();

            ctx.restore();
        }
    };

    function padSingleDayData(data) {
        if (data.labels.length === 1) {
            return {
                labels: ["", data.labels[0], ""],
                clicks: [null, data.clicks[0], null],
                impressions: [null, data.impressions[0], null],
                unique_clicks: [null, data.unique_clicks[0], null]
            };
        }
        return data;
    }


    function createChart(inputData) {
        const data = padSingleDayData(inputData);

        const canvas = document.getElementById('dashboardAnalyticsChart');
        if (!canvas) {
            console.error('Canvas element not found');
            return;
        }

        // Optional: Scale width based on data points (30px per label)
        canvas.width = data.labels.length * 30;

        const ctx = canvas.getContext('2d');
        const maxValue = getMaxValue(data);

        let tooltipEl = document.getElementById('chartjs-tooltip');
        if (!tooltipEl) {
            tooltipEl = document.createElement('div');
            tooltipEl.id = 'chartjs-tooltip';
            document.body.appendChild(tooltipEl);
            Object.assign(tooltipEl.style, {
                position: 'absolute',
                pointerEvents: 'none',
                background: '#fff',
                borderRadius: '12px',
                boxShadow: '0 6px 20px rgba(0,0,0,0.12)',
                padding: '12px 20px',
                fontSize: '14px',
                color: '#000',
                transform: 'translate(-50%, -100%)',
                whiteSpace: 'nowrap',
                zIndex: '1000',
                display: 'none'
            });
        }

        const isSingleDay = data.labels.length === 3;

        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: 'Clicks',
                        data: data.clicks,
                        borderColor: '#4D7FFF',
                        pointBackgroundColor: '#4D7FFF',
                        pointBorderColor: '#4D7FFF',
                        pointRadius: isSingleDay ? 7 : 0,
                        pointHoverRadius: 7,
                        borderWidth: 2,
                        tension: 0.4,
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 4,
                        fill: false,
                        clip: false
                    },
                    {
                        label: 'Impressions',
                        data: data.impressions,
                        borderColor: '#10B981',
                        pointBackgroundColor: '#10B981',
                        pointBorderColor: '#10B981',
                        pointRadius: isSingleDay ? 7 : 0,
                        pointHoverRadius: 7,
                        borderWidth: 2,
                        tension: 0.4,
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 4,
                        fill: false,
                        clip: false
                    },
                    {
                        label: 'Unique Clicks',
                        data: data.unique_clicks,
                        borderColor: '#F59E0B',
                        pointBackgroundColor: '#F59E0B',
                        pointBorderColor: '#F59E0B',
                        pointRadius: isSingleDay ? 7 : 0,
                        pointHoverRadius: 7,
                        borderWidth: 2,
                        tension: 0.4,
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 4,
                        fill: false,
                        clip: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        enabled: false,
                        external: function (context) {
                            const tooltipModel = context.tooltip;

                            if (tooltipModel.opacity === 0) {
                                tooltipEl.style.display = 'none';
                                return;
                            }

                            const canvasRect = context.chart.canvas.getBoundingClientRect();
                            let adjustedCaretX = tooltipModel.caretX;
                            const tooltipOffsetX = isSingleDay ? 0 : 50;
                            const tooltipOffsetY = 40;

                            if (isSingleDay) {
                                adjustedCaretX = context.chart.width / 2;
                            }

                            const left = canvasRect.left + window.pageXOffset + adjustedCaretX + tooltipOffsetX;
                            const top = canvasRect.top + window.pageYOffset + tooltipModel.caretY - tooltipOffsetY;

                            tooltipEl.style.left = left + 'px';
                            tooltipEl.style.top = top + 'px';
                            tooltipEl.style.display = 'block';

                            const firstDataPoint = tooltipModel.dataPoints[0];
                            const hoverDate = firstDataPoint.label || firstDataPoint.parsed.x || '';

                            let innerHtml = `
                                <div style="font-weight:bold; margin-bottom:8px;">
                                    ${hoverDate}
                                </div>
                            `;

                            tooltipModel.dataPoints.forEach(dataPoint => {
                                const color = dataPoint.dataset.borderColor || dataPoint.dataset.backgroundColor;
                                const value = dataPoint.parsed.y ?? dataPoint.raw ?? dataPoint.formattedValue;
                                const formattedValue = Number(value).toLocaleString();
                                const title = dataPoint.dataset.label || '';

                                innerHtml += `
                                    <div style="display:flex; align-items:center; margin-bottom:6px;">
                                        <span style="
                                            display:inline-block;
                                            width:12px;
                                            height:12px;
                                            border-radius:50%;
                                            background-color:${color};
                                            margin-right:10px;
                                        "></span>
                                        <span>${formattedValue} ${title}</span>
                                    </div>
                                `;
                            });

                            tooltipEl.innerHTML = innerHtml;
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        suggestedMax: maxValue + (maxValue * 0.2),
                        ticks: {
                            display: false
                        },
                        grid: {
                            display: false,
                            drawBorder: false
                        },
                        border: {
                            display: false,
                            color: 'transparent',
                            width: 0
                        }
                    },
                    x: {
                        ticks: {
                            color: '#666',
                            font: {
                                size: 12
                            },
                            callback: function (value, index) {
                                const label = this.getLabelForValue(index);
                                return label === "" ? "" : label;
                            }
                        },
                        grid: {
                            display: false,
                            drawBorder: false
                        },
                        border: {
                            display: false,
                            color: 'transparent',
                            width: 0
                        }
                    }
                }
            },
            plugins: [verticalGradientHighlightPlugin, lineShadowFillPlugin]
        });
    }

    function updateChart(inputData) {
        const data = padSingleDayData(inputData);
        const maxValue = getMaxValue(data);

        chart.data.labels = data.labels;
        chart.data.datasets[0].data = data.clicks;
        chart.data.datasets[1].data = data.impressions;
        chart.data.datasets[2].data = data.unique_clicks;

        chart.options.scales.y.suggestedMax = maxValue + (maxValue * 0.2);

        const isSingleDay = data.labels.length === 3;
        chart.data.datasets.forEach(ds => {
            ds.pointRadius = isSingleDay ? 7 : 0;
        });

        chart.update();
    }


    function loadChartData(range, startDate, endDate) {
        fetch(`%%DEFINE_ROOT_LINK%%/analytics/getDashboardChartData?range=${range}&start=${startDate}&end=${endDate}`)
            .then(response => response.json())
            .then(data => {
                if (chart) {
                    updateChart(data);
                } else {
                    createChart(data);
                }
                $("#total_clicks").html(data.total_clicks);
                $("#total_impressions").html(data.total_impressions);
                $("#total_unique_clicks").html(data.total_unique_clicks);
                $("#total_clicks_chart").html(data.total_clicks);
                $("#clickThroughRate").html(data.clickThroughRate + "<span>%</span>");

                const change = data.rateChange ?? 0;

                const changeValue = Number(change); // Ensure it's a number
                const $changeElem = $('#clickThroughChange'); // jQuery selector

                if (changeValue < 0) {
                    $changeElem.html(`â–¼ ${Math.abs(changeValue)}%`)
                        .addClass('kt-badge-destructive')
                        .removeClass('kt-badge-success');
                } else {
                    $changeElem.html(`â–² ${changeValue}%`)
                        .addClass('kt-badge-success')
                        .removeClass('kt-badge-destructive');
                }
            })
            .catch(error => console.error('Error loading chart data:', error));
    }



    function getDateRange(range) {
        const today = new Date();
        let startDate, endDate;

        switch (range) {
            case 'today':
                startDate = endDate = today;
                break;
            case 'yesterday':
                startDate = endDate = new Date(today.setDate(today.getDate() - 1));
                break;
            case 'this-week':
                const firstDayOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
                startDate = firstDayOfWeek;
                endDate = new Date();
                break;
            case 'last-week':
                const lastWeekEnd = new Date(today.setDate(today.getDate() - today.getDay() - 1));
                const lastWeekStart = new Date(lastWeekEnd);
                lastWeekStart.setDate(lastWeekEnd.getDate() - 6);
                startDate = lastWeekStart;
                endDate = lastWeekEnd;
                break;
            case 'this-month':
                startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                endDate = new Date();
                break;
            case 'last-month':
                const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                startDate = new Date(lastMonth.getFullYear(), lastMonth.getMonth(), 1);
                endDate = new Date(lastMonth.getFullYear(), lastMonth.getMonth() + 1, 0);
                break;
            case 'this-year':
                startDate = new Date(today.getFullYear(), 0, 1);
                endDate = new Date();
                break;
            default:
                startDate = endDate = today;
        }

        // Format as YYYY-MM-DD
        const formatLocal = d => {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0'); // months are 0-based
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        return {
            startDate: formatLocal(startDate),
            endDate: formatLocal(endDate)
        };
    }

    chart = '';
    const { startDate, endDate } = getDateRange('this-month');
    loadChartData('days', startDate, endDate);
    $('.chart-range-option').on('click', function () {
        const range = $(this).data('range');
        const { startDate, endDate } = getDateRange(range);
        loadChartData('days', startDate, endDate);
    });
</script>
%%DEFINE_FOOTER%%